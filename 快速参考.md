# Envoy è¿ç»´å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¿«é€Ÿè®¿é—®

### ä» Windows ç™»å½•
```powershell
ssh -i "C:\Key\www.qsgl.cn_id_ed25519" root@www.qsgl.cn
```

---

## âš¡ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹çŠ¶æ€
```bash
docker ps | grep envoy-proxy              # å®¹å™¨çŠ¶æ€
docker logs -f envoy-proxy                # å®æ—¶æ—¥å¿—
curl http://localhost:9901/ready          # Envoy å°±ç»ªæ£€æŸ¥
```

### æœåŠ¡æ§åˆ¶
```bash
docker restart envoy-proxy                # é‡å¯æœåŠ¡
docker stop envoy-proxy                   # åœæ­¢æœåŠ¡
docker start envoy-proxy                  # å¯åŠ¨æœåŠ¡
```

### è¯Šæ–­å’Œç›‘æ§
```bash
bash /root/envoy/diagnose.sh              # è¿è¡Œè¯Šæ–­
bash /root/envoy/monitor.sh               # æ‰‹åŠ¨ç›‘æ§
tail -f /var/log/envoy-monitor.log        # æŸ¥çœ‹ç›‘æ§æ—¥å¿—
```

---

## ğŸ“‹ å…³é”®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **å®¹å™¨å** | envoy-proxy |
| **é•œåƒ** | envoy-proxy:latest |
| **ç½‘ç»œæ¨¡å¼** | host |
| **HTTPS ç«¯å£** | 443 |
| **ç®¡ç†ç«¯å£** | 9901 |
| **é…ç½®æ–‡ä»¶** | /etc/envoy/envoy.yaml |
| **è¯ä¹¦ç›®å½•** | /etc/envoy/ |
| **ç›‘æ§é¢‘ç‡** | æ¯5åˆ†é’Ÿ |
| **å‘Šè­¦é‚®ç®±** | qsoft@139.com |

---

## ğŸ”¥ å…³é”®é—®é¢˜æé†’

### âš ï¸ ç§é’¥æƒé™å¿…é¡»æ˜¯ 644
```bash
# å¦‚æœå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥å¹¶ä¿®å¤æƒé™ï¼š
chmod 644 /etc/envoy/*.key
docker restart envoy-proxy
```

### âš ï¸ è¯ä¹¦æ›´æ–°åé‡å¯
```bash
# æ›´æ–°è¯ä¹¦åï¼š
docker restart envoy-proxy
```

---

## ğŸ“Š ç›‘æ§ä¿¡æ¯

- **ç›‘æ§è„šæœ¬**: `/root/envoy/monitor.sh`
- **Crontab**: `*/5 * * * * /root/envoy/monitor.sh >> /var/log/envoy-monitor.log 2>&1`
- **ç›‘æ§æ—¥å¿—**: `/var/log/envoy-monitor.log`
- **æ£€æŸ¥é¡¹ç›®**: å®¹å™¨çŠ¶æ€ã€Envoyæ¥å£ã€ç«¯å£ç›‘å¬(443,9901)ã€é‡å¯æ¬¡æ•°

---

## ğŸ†˜ æ•…éšœé€ŸæŸ¥

### å®¹å™¨ä¸æ–­é‡å¯
```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs envoy-proxy --tail 50

# 2. æ£€æŸ¥ç§é’¥æƒé™ï¼ˆæœ€å¸¸è§é—®é¢˜ï¼‰
ls -l /etc/envoy/*.key
chmod 644 /etc/envoy/*.key

# 3. éªŒè¯é…ç½®æ–‡ä»¶
docker run --rm -v /etc/envoy:/etc/envoy envoy-proxy \
  envoy --mode validate -c /etc/envoy/envoy.yaml
```

### HTTPS æ— æ³•è®¿é—®
```bash
# 1. æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tuln | grep 443
ss -tuln | grep 443

# 2. æ£€æŸ¥ Envoy çŠ¶æ€
curl http://localhost:9901/ready

# 3. æµ‹è¯•æœ¬åœ°è®¿é—®
curl -Ik https://localhost
```

### æœªæ”¶åˆ°å‘Šè­¦é‚®ä»¶
```bash
# 1. æ£€æŸ¥ç›‘æ§æ—¥å¿—
tail -20 /var/log/envoy-monitor.log

# 2. æ‰‹åŠ¨è¿è¡Œç›‘æ§
bash /root/envoy/monitor.sh

# 3. æ£€æŸ¥ crontab
crontab -l | grep monitor
```

---

## ğŸ“ æ–‡æ¡£ä½ç½®

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| è¿ç»´æ‰‹å†Œ | /root/envoy/README.md | å®Œæ•´è¿ç»´æ–‡æ¡£ |
| éƒ¨ç½²æŒ‡å— | /root/envoy/DEPLOY.md | éƒ¨ç½²æ­¥éª¤ |
| é—®é¢˜è®°å½• | /root/envoy/é—®é¢˜ä¿®å¤è¯´æ˜.md | å…³é”®é—®é¢˜è§£å†³ |
| éƒ¨ç½²æ€»ç»“ | /root/envoy/éƒ¨ç½²æ€»ç»“.md | å®Œæ•´æ€»ç»“æŠ¥å‘Š |

---

## ğŸŒ æœåŠ¡éªŒè¯

```bash
# Envoy å°±ç»ªæ£€æŸ¥
curl http://localhost:9901/ready
# è¾“å‡º: LIVE

# HTTPS è®¿é—®æµ‹è¯•
curl -Ik https://www.qsgl.cn
# åº”è¿”å›: HTTP/2 200

# ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:9901/stats | grep http
```

---

## ğŸ’¾ å¤‡ä»½å»ºè®®

```bash
# å¤‡ä»½é…ç½®å’Œè¯ä¹¦
tar -czf envoy-backup-$(date +%Y%m%d).tar.gz \
  /etc/envoy /root/envoy

# å¤‡ä»½åˆ°å…¶ä»–ä½ç½®
cp envoy-backup-*.tar.gz /backup/
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

- âœ… å®¹å™¨çŠ¶æ€: Up
- âœ… Envoy å°±ç»ª: LIVE  
- âœ… HTTPS è®¿é—®: HTTP/2 200
- âœ… ç›‘æ§æ­£å¸¸: âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡
- âœ… å‘Šè­¦åŠŸèƒ½: é‚®ä»¶å‘é€æˆåŠŸ

---

**æœ€åæ›´æ–°**: 2025-10-24  
**è¿ç»´å›¢é˜Ÿ**: qsoft@139.com
