# Envoy 运维快速参考

## 🚀 快速访问

### 从 Windows 登录
```powershell
ssh -i "C:\Key\www.qsgl.cn_id_ed25519" root@www.qsgl.cn
```

---

## ⚡ 常用命令

### 查看状态
```bash
docker ps | grep envoy-proxy              # 容器状态
docker logs -f envoy-proxy                # 实时日志
curl http://localhost:9901/ready          # Envoy 就绪检查
```

### 服务控制
```bash
docker restart envoy-proxy                # 重启服务
docker stop envoy-proxy                   # 停止服务
docker start envoy-proxy                  # 启动服务
```

### 诊断和监控
```bash
bash /root/envoy/diagnose.sh              # 运行诊断
bash /root/envoy/monitor.sh               # 手动监控
tail -f /var/log/envoy-monitor.log        # 查看监控日志
```

---

## 📋 关键信息

| 项目 | 值 |
|------|-----|
| **容器名** | envoy-proxy |
| **镜像** | envoy-proxy:latest |
| **网络模式** | host |
| **HTTPS 端口** | 443 |
| **管理端口** | 9901 |
| **配置文件** | /etc/envoy/envoy.yaml |
| **证书目录** | /etc/envoy/ |
| **监控频率** | 每5分钟 |
| **告警邮箱** | qsoft@139.com |

---

## 🔥 关键问题提醒

### ⚠️ 私钥权限必须是 644
```bash
# 如果容器启动失败，检查并修复权限：
chmod 644 /etc/envoy/*.key
docker restart envoy-proxy
```

### ⚠️ 证书更新后重启
```bash
# 更新证书后：
docker restart envoy-proxy
```

---

## 📊 监控信息

- **监控脚本**: `/root/envoy/monitor.sh`
- **Crontab**: `*/5 * * * * /root/envoy/monitor.sh >> /var/log/envoy-monitor.log 2>&1`
- **监控日志**: `/var/log/envoy-monitor.log`
- **检查项目**: 容器状态、Envoy接口、端口监听(443,9901)、重启次数

---

## 🆘 故障速查

### 容器不断重启
```bash
# 1. 查看错误日志
docker logs envoy-proxy --tail 50

# 2. 检查私钥权限（最常见问题）
ls -l /etc/envoy/*.key
chmod 644 /etc/envoy/*.key

# 3. 验证配置文件
docker run --rm -v /etc/envoy:/etc/envoy envoy-proxy \
  envoy --mode validate -c /etc/envoy/envoy.yaml
```

### HTTPS 无法访问
```bash
# 1. 检查端口监听
netstat -tuln | grep 443
ss -tuln | grep 443

# 2. 检查 Envoy 状态
curl http://localhost:9901/ready

# 3. 测试本地访问
curl -Ik https://localhost
```

### 未收到告警邮件
```bash
# 1. 检查监控日志
tail -20 /var/log/envoy-monitor.log

# 2. 手动运行监控
bash /root/envoy/monitor.sh

# 3. 检查 crontab
crontab -l | grep monitor
```

---

## 📁 文档位置

| 文档 | 路径 | 说明 |
|------|------|------|
| 运维手册 | /root/envoy/README.md | 完整运维文档 |
| 部署指南 | /root/envoy/DEPLOY.md | 部署步骤 |
| 问题记录 | /root/envoy/问题修复说明.md | 关键问题解决 |
| 部署总结 | /root/envoy/部署总结.md | 完整总结报告 |

---

## 🌐 服务验证

```bash
# Envoy 就绪检查
curl http://localhost:9901/ready
# 输出: LIVE

# HTTPS 访问测试
curl -Ik https://www.qsgl.cn
# 应返回: HTTP/2 200

# 统计信息
curl http://localhost:9901/stats | grep http
```

---

## 💾 备份建议

```bash
# 备份配置和证书
tar -czf envoy-backup-$(date +%Y%m%d).tar.gz \
  /etc/envoy /root/envoy

# 备份到其他位置
cp envoy-backup-*.tar.gz /backup/
```

---

## 🎯 成功指标

- ✅ 容器状态: Up
- ✅ Envoy 就绪: LIVE  
- ✅ HTTPS 访问: HTTP/2 200
- ✅ 监控正常: ✓ 所有检查通过
- ✅ 告警功能: 邮件发送成功

---

**最后更新**: 2025-10-24  
**运维团队**: qsoft@139.com
